<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StudyMate - Smart Study Planner (Fixed API Integration)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="A responsive web app for students to organize and track their exam preparation, featuring improved Grok API integration with proper error handling, alternative processing methods, and comprehensive troubleshooting for API connectivity issues.">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/roboto@3.3.1/roboto.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="icon" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/svgs/solid/user-graduate.svg">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #f9fafb;
      color: #1a202c;
      transition: background 0.3s, color 0.3s;
    }
    .darkmode {
      background-color: #22232a;
      color: #e5e7eb;
    }
    .dark-card {
      background-color: #2d2e36;
      color: #e5e7eb;
    }
    .dark-input {
      background-color: #3a3b46 !important;
      color: #e5e7eb !important;
      border-color: #4b4c57 !important;
    }
    .dark-border {
      border-color: #4b4c57 !important;
    }
    /* Fix dropdown text color */
    select, input, textarea {
      color: #1a202c;
    }
    .darkmode select, .darkmode input, .darkmode textarea {
      color: #e5e7eb;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .kanban-shadow {
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.04),0 1.5px 2.5px 0 rgba(0,0,0,0.04);
    }
    .quote-gradient {
      background: linear-gradient(90deg, #5EEAD4, #818CF8 60%, #F472B6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Improved Topic Knowledge Base styling */
    #topicContent {
      color: #1a202c;
    }
    #topicContent h1, 
    #topicContent h2, 
    #topicContent h3, 
    #topicContent h4, 
    #topicContent h5, 
    #topicContent h6 {
      color: #1e3a8a;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    #topicContent p {
      color: #1a202c;
      margin-bottom: 1rem;
    }
    #topicContent ul, 
    #topicContent ol {
      color: #1a202c;
      margin-left: 1.25rem;
      margin-bottom: 1rem;
    }
    #topicContent li {
      margin-bottom: 0.25rem;
    }
    #topicContent a {
      color: #2563eb;
      text-decoration: underline;
    }
    #topicContent pre {
      background-color: #f3f4f6;
      padding: 0.75rem;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
      overflow-x: auto;
    }
    #topicContent code {
      font-family: monospace;
      background-color: #f3f4f6;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      color: #1e40af;
    }
    /* Dark mode overrides */
    .darkmode #topicContent {
      color: #e5e7eb;
    }
    .darkmode #topicContent h1, 
    .darkmode #topicContent h2, 
    .darkmode #topicContent h3, 
    .darkmode #topicContent h4, 
    .darkmode #topicContent h5, 
    .darkmode #topicContent h6 {
      color: #93c5fd;
    }
    .darkmode #topicContent p,
    .darkmode #topicContent ul,
    .darkmode #topicContent ol,
    .darkmode #topicContent li {
      color: #e5e7eb;
    }
    .darkmode #topicContent a {
      color: #60a5fa;
    }
    .darkmode #topicContent pre {
      background-color: #374151;
    }
    .darkmode #topicContent code {
      background-color: #374151;
      color: #93c5fd;
    }
    /* New styles for improved UI */
    .card {
      border-radius: 0.75rem;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .section-title {
      position: relative;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
    }
    .section-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(90deg, #5EEAD4, #818CF8);
    }
    .animate-fade {
      animation: fade-in 0.5s ease-in-out;
    }
    @keyframes fade-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    /* Improved contrast for dark mode */
    .darkmode .mermaid .node rect,
    .darkmode .mermaid .node circle,
    .darkmode .mermaid .node ellipse,
    .darkmode .mermaid .node polygon,
    .darkmode .mermaid .node path {
      fill: #3a3b46 !important;
      stroke: #8b8b9e !important;
    }
    .darkmode .mermaid .label {
      color: #e5e7eb !important;
    }
    .darkmode .mermaid text {
      fill: #e5e7eb !important;
    }
    .darkmode .mermaid .edgeLabel {
      background-color: #2d2e36 !important;
      color: #e5e7eb !important;
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="max-w-5xl mx-auto px-4 py-6">
    <header class="flex flex-wrap items-center justify-between space-y-4 md:space-y-0 mb-6">
      <div class="flex items-center space-x-3">
        <i class="fas fa-user-graduate text-indigo-600 text-3xl"></i>
        <span class="text-2xl font-bold tracking-tight">StudyMate</span>
      </div>
      <div class="flex items-center space-x-2">
        <button id="exportPdfBtn" class="px-3 py-1 rounded bg-indigo-500 text-white hover:bg-indigo-600 text-sm"><i class="fas fa-file-pdf"></i> Export PDF</button>
        <button id="focusModeBtn" class="px-3 py-1 rounded bg-teal-500 text-white hover:bg-teal-600 text-sm"><i class="fas fa-bullseye"></i> Focus Mode</button>
        <button id="darkModeBtn" class="px-3 py-1 rounded bg-gray-700 text-white hover:bg-gray-900 text-sm"><i class="fas fa-moon"></i> Dark Mode</button>
      </div>
    </header>
    <section id="grok-api-section" class="mb-6">
      <div class="p-4 bg-white darkmode:bg-gray-800 shadow rounded flex flex-col md:flex-row md:items-center md:space-x-4 space-y-2 md:space-y-0">
        <div class="flex items-center space-x-2">
          <i class="fas fa-robot text-teal-400 text-2xl"></i>
          <b class="block">Grok API Integration</b>
        </div>
        <label class="block w-full md:w-auto">
          <input type="text" id="grokApiKey" class="mt-1 py-1 px-3 bg-gray-100 darkmode:bg-gray-700 rounded border border-gray-300 text-sm w-full md:w-64" placeholder="Paste your Grok API Key here">
        </label>
        <button id="grokSaveBtn" class="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">Verify API Key</button>
        <span id="grokApiStatus" class="ml-2 text-xs"></span>
      </div>
      <div id="grokApiAuthMessage" class="mt-2 text-xs text-center text-indigo-600 hidden">
        <i class="fas fa-info-circle"></i> Please verify your API key to enable PDF processing with Grok AI
      </div>
    </section>

    <section id="intro-section" class="mb-6">
      <div class="bg-white darkmode:bg-gray-800 shadow rounded p-4">
        <h2 class="text-xl font-bold mb-1">Smart Study Plan Setup</h2>
        <p class="text-sm mb-3">Upload your syllabus or enter topics, and StudyMate will create a personalized plan leveraging Grok AI for improved parsing and topic understanding.</p>
        <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
          <div class="relative">
          <input type="file" id="pdfInput" accept="application/pdf" class="block w-full md:w-72 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:bg-teal-100 file:text-teal-700 hover:file:bg-teal-200" />
            <div id="pdfProcessingOverlay" class="hidden absolute inset-0 bg-gray-100 bg-opacity-80 flex items-center justify-center rounded">
              <div class="text-indigo-600"><i class="fas fa-spinner fa-spin mr-2"></i>Processing PDF...</div>
            </div>
          </div>
          <button id="toggleManualAdd" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm flex items-center"><i class="fas fa-keyboard mr-2"></i>Manual Entry</button>
        </div>
        <div id="pdfProcessMsg" class="mt-4 text-sm text-teal-600 hidden"></div>
        <div id="pdfAnalysisDetails" class="mt-3 text-xs text-gray-600 hidden">
          <div class="mb-1"><i class="fas fa-check-circle text-green-500 mr-1"></i> PDF analyzed with Grok AI for topic identification</div>
          <div class="mb-1"><i class="fas fa-check-circle text-green-500 mr-1"></i> Content processed to extract key study concepts</div>
          <div><i class="fas fa-check-circle text-green-500 mr-1"></i> Subjects prioritized based on content analysis</div>
        </div>
        <div id="manualAddSection" class="hidden mt-4">
          <label class="font-semibold mb-1 block">Add Topics Manually (per Subject):</label>
          <div id="manualSubjects" class="space-y-2"></div>
          <button id="addSubjectBtn" class="text-teal-700 bg-teal-100 rounded px-2 py-1 mt-2 hover:bg-teal-200"><i class="fas fa-plus"></i> Add Subject</button>
        </div>
      </div>
      <div id="apiErrorMsg" class="mt-4 text-sm text-red-600 hidden"></div>
    </section>

    <section id="plan-gen-section" class="mb-6">
      <form id="planGenForm" class="bg-white darkmode:bg-gray-800 shadow rounded p-4 space-y-3">
        <h3 class="font-bold text-lg mb-2">Exam & Subject Details</h3>
        <div class="flex flex-col md:flex-row md:space-x-6 space-y-3 md:space-y-0">
          <div class="w-full md:w-1/3">
            <label class="block text-sm mb-1 font-semibold">Exam Start Date</label>
            <input required type="date" id="examStart" class="w-full px-3 py-1 rounded border border-gray-300 bg-gray-100 darkmode:bg-gray-700" min="2024-01-01" />
          </div>
          <div class="w-full md:w-1/3">
            <label class="block text-sm mb-1 font-semibold">Exam End Date</label>
            <input required type="date" id="examEnd" class="w-full px-3 py-1 rounded border border-gray-300 bg-gray-100 darkmode:bg-gray-700" min="2024-01-02" />
          </div>
          <div class="w-full md:w-1/3">
            <label class="block text-sm mb-1 font-semibold">Routine Preferences</label>
            <select id="routinePref" class="w-full px-3 py-1 rounded border border-gray-300 bg-gray-100 darkmode:bg-gray-700">
              <option value="standard">Standard (AM-Theory/PM-Practice/Evening-Rev)</option>
              <option value="custom">Custom (set below)</option>
            </select>
          </div>
        </div>
        <div id="customRoutineInputs" class="space-y-2 mt-2 hidden">
          <label class="block font-semibold">Set Routine Hours:</label>
          <div class="flex flex-col md:flex-row md:space-x-6">
            <input class="px-2 py-1 rounded border border-gray-300 w-full md:w-24 bg-gray-100 darkmode:bg-gray-700 mr-2" id="amSlot" placeholder="AM start (e.g. 07:00)" type="time"/>
            <input class="px-2 py-1 rounded border border-gray-300 w-full md:w-24 bg-gray-100 darkmode:bg-gray-700 mr-2" id="pmSlot" placeholder="PM start (e.g. 13:00)" type="time"/>
            <input class="px-2 py-1 rounded border border-gray-300 w-full md:w-24 bg-gray-100 darkmode:bg-gray-700" id="eveSlot" placeholder="Eve start (e.g. 18:00)" type="time"/>
          </div>
        </div>
        <div class="flex flex-col space-y-2">
          <label class="font-semibold">Subjects & Weight (Credits or Priority Level):</label>
          <div id="subjectWeightInputs" class="flex flex-col space-y-2"></div>
        </div>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold text-sm"><i class="fas fa-magic mr-2"></i>Generate Plan</button>
      </form>
    </section>

    <section id="dashboard-section" class="mb-8">
      <h2 class="text-xl font-bold mb-4 flex items-center section-title"><i class="fas fa-tasks text-teal-500 mr-2"></i>Interactive Dashboard & Progress</h2>
      <div class="flex flex-row flex-wrap gap-4 mb-6" id="subjectCards"></div>
      <div class="bg-white dark-card rounded p-4 shadow w-full mb-4">
        <h3 class="text-lg font-semibold mb-3">Progress Overview</h3>
        <div style="height: 250px; max-height: 250px; position: relative;">
          <canvas id="progressChart"></canvas>
        </div>
      </div>
    </section>

    <section id="daily-schedule-section" class="mb-8">
      <h2 class="text-xl font-bold mb-2 flex items-center section-title"><i class="fas fa-calendar-alt text-indigo-500 mr-2"></i>Daily Routine Scheduler</h2>
      <div id="dailyRoutineCalendar" class="w-full space-y-3"></div>
    </section>

    <section id="workflow-section" class="mb-8 hidden">
      <h2 class="text-xl font-bold mb-2 flex items-center section-title"><i class="fas fa-project-diagram text-teal-500 mr-2"></i>Study Path Visualization</h2>
      <div class="bg-white dark-card rounded p-4 shadow">
        <p class="text-sm mb-4">Visualize your optimal study path with AI-generated workflow diagrams.</p>
        <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0 mb-4">
          <select id="workflowSubject" class="block w-full md:w-auto px-3 py-2 bg-gray-100 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded text-sm">
            <option value="">Select a subject</option>
            <!-- Will be populated dynamically -->
          </select>
          <button id="generateWorkflowBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">
            <i class="fas fa-magic mr-2"></i>Generate Learning Path
          </button>
        </div>
        <div id="workflowLoading" class="hidden">
          <div class="flex items-center justify-center py-6">
            <div class="text-indigo-600 dark:text-indigo-400"><i class="fas fa-spinner fa-spin mr-2"></i>Generating study path diagram...</div>
          </div>
        </div>
        <div id="workflowContent" class="mt-4"></div>
      </div>
    </section>

    <section id="topic-explanation-section" class="mb-8 hidden">
      <h2 class="text-xl font-bold mb-2 flex items-center section-title"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Topic Knowledge Base</h2>
      <div class="bg-white dark-card rounded p-4 shadow">
        <p class="text-sm mb-4">Get detailed explanations on any study topic using Grok AI.</p>
        <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0 mb-4">
          <input type="text" id="topicQuery" class="block w-full md:w-80 px-3 py-2 bg-gray-100 dark:bg-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded text-sm" placeholder="Enter a topic to learn about...">
          <button id="explainTopicBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded text-sm">
            <i class="fas fa-search mr-2"></i>Get Knowledge
          </button>
        </div>
        <div id="topicLoading" class="hidden">
          <div class="flex items-center justify-center py-6">
            <div class="text-teal-600 dark:text-teal-400"><i class="fas fa-spinner fa-spin mr-2"></i>Generating explanation...</div>
          </div>
        </div>
        <div id="topicContent" class="mt-4 bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-700"></div>
      </div>
    </section>

    <section id="motivation-section" class="mb-10">
      <div class="bg-gradient-to-br from-teal-200 via-indigo-100 to-pink-100 rounded p-4 shadow flex items-center space-x-2">
        <i class="fas fa-quote-left text-xl text-indigo-500"></i>
        <span id="motivationQuote" class="font-semibold text-lg quote-gradient"></span>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-500 pb-2">
      &copy; 2024 StudyMate &bullet; Designed for PDF export &bull; <i class="fas fa-leaf text-teal-400"></i> Good luck with your studies!
    </footer>
  </div>
  <script>
    // --- DARK MODE LOGIC ---
    const darkBtn = document.getElementById('darkModeBtn');
    let darkMode = false;
    
    function toggleDarkMode(enable) {
      darkMode = enable;
      document.body.classList.toggle('darkmode', darkMode);
      
      // Update all cards and inputs with dark mode classes
      if (darkMode) {
        document.querySelectorAll('.bg-white').forEach(el => {
          el.classList.remove('bg-white');
          el.classList.add('dark-card');
        });
        
        document.querySelectorAll('input, select, textarea').forEach(el => {
          el.classList.add('dark-input');
          // Add dark mode Tailwind classes
          el.classList.add('dark:bg-gray-700');
          el.classList.add('dark:text-gray-100');
          el.classList.add('dark:border-gray-600');
          // Remove light mode classes if present
          el.classList.remove('bg-gray-100');
          el.classList.add('bg-gray-700');
        });
        
        document.querySelectorAll('.border, [class*="border-"]').forEach(el => {
          el.classList.add('dark-border');
        });
        
        // Update light-specific background colors
        document.querySelectorAll('.bg-gray-50').forEach(el => {
          el.classList.remove('bg-gray-50');
          el.classList.add('dark:bg-gray-800');
        });
        
        darkBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
      } else {
        document.querySelectorAll('.dark-card').forEach(el => {
          el.classList.add('bg-white');
          el.classList.remove('dark-card');
        });
        
        document.querySelectorAll('input, select, textarea').forEach(el => {
          el.classList.remove('dark-input');
          // Remove dark mode Tailwind classes for inputs
          el.classList.remove('dark:bg-gray-700');
          el.classList.remove('dark:text-gray-100');
          el.classList.remove('dark:border-gray-600');
          // Add light mode classes back
          el.classList.add('bg-gray-100');
          el.classList.remove('bg-gray-700');
        });
        
        document.querySelectorAll('.dark-border').forEach(el => {
          el.classList.remove('dark-border');
        });
        
        // Restore light-specific background colors
        document.querySelectorAll('.dark\\:bg-gray-800').forEach(el => {
          if (!el.classList.contains('bg-gray-50')) {
            el.classList.add('bg-gray-50');
          }
        });
        
        darkBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
      }
      
      // Update chart colors if chart exists
      if (chart) {
        chart.options.scales.x.grid.color = darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
        chart.update();
      }
      
      // Force refresh mermaid diagrams
      if (typeof mermaid !== 'undefined') {
        // Clear any existing mermaid diagrams and recreate them
        const mermaidDivs = document.querySelectorAll('.mermaid');
        if (mermaidDivs.length > 0) {
          const mermaidContents = [];
          mermaidDivs.forEach(div => {
            mermaidContents.push(div.textContent);
            div.removeAttribute('data-processed');
          });
          
          // Configure mermaid with new theme
          configureMermaid();
          
          // Rerun mermaid on the diagrams
          try {
            mermaid.run();
          } catch (e) {
            console.error('Error refreshing mermaid diagrams:', e);
            // If error, try recreating the diagrams
            mermaidDivs.forEach((div, i) => {
              div.textContent = mermaidContents[i];
            });
            setTimeout(() => mermaid.run(), 100);
          }
        }
      }
    }
    
    darkBtn.addEventListener('click', () => {
      toggleDarkMode(!darkMode);
    });

    // --- FOCUS MODE ---
    let focusMode = false;
    document.getElementById('focusModeBtn').onclick = function() {
      focusMode = !focusMode;
      
      // Hide everything except today's tasks
      document.getElementById('intro-section').style.display = focusMode ? 'none' : '';
      document.getElementById('plan-gen-section').style.display = focusMode ? 'none' : '';
      document.getElementById('dashboard-section').style.display = focusMode ? 'none' : '';
      document.getElementById('grok-api-section').style.display = focusMode ? 'none' : '';
      
      // Show only today's tasks in a cleaner view
      const today = new Date().toISOString().slice(0,10);
      
      if (focusMode && studyPlan.plan && studyPlan.plan[today]) {
        document.getElementById('daily-schedule-section').innerHTML = `
          <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-bullseye text-indigo-500 mr-2"></i>Today's Focus</h2>
          <div class="bg-white darkmode:bg-gray-800 rounded-lg p-6 shadow-lg">
            <div class="mb-4 text-center">
              <span class="text-xl font-bold">${today}</span>
              <span class="text-sm ml-2 text-gray-500">${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(today).getDay()]}</span>
            </div>
            <div class="space-y-6">
              <div class="flex items-center space-x-4">
                <div class="bg-teal-100 darkmode:bg-teal-900 p-3 rounded-full">
                  <i class="fas fa-sun text-teal-700 darkmode:text-teal-300 text-lg"></i>
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold mb-2">Morning</h3>
                  <div class="space-y-2">
                    ${studyPlan.plan[today].am.map(o=> `
                      <div class="flex items-center space-x-2">
                        <input type="checkbox" class="h-4 w-4 text-teal-600">
                        <span class="text-sm">${o.subject}: ${o.topic}</span>
                      </div>
                    `).join('') || '<span class="text-gray-400 text-sm">No tasks scheduled</span>'}
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <div class="bg-indigo-100 darkmode:bg-indigo-900 p-3 rounded-full">
                  <i class="fas fa-clock text-indigo-700 darkmode:text-indigo-300 text-lg"></i>
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold mb-2">Afternoon</h3>
                  <div class="space-y-2">
                    ${studyPlan.plan[today].pm.map(o=> `
                      <div class="flex items-center space-x-2">
                        <input type="checkbox" class="h-4 w-4 text-indigo-600">
                        <span class="text-sm">${o.subject}: ${o.topic}</span>
                      </div>
                    `).join('') || '<span class="text-gray-400 text-sm">No tasks scheduled</span>'}
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <div class="bg-pink-100 darkmode:bg-pink-900 p-3 rounded-full">
                  <i class="fas fa-moon text-pink-700 darkmode:text-pink-300 text-lg"></i>
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold mb-2">Evening</h3>
                  <div class="space-y-2">
                    ${studyPlan.plan[today].eve.map(o=> `
                      <div class="flex items-center space-x-2">
                        <input type="checkbox" class="h-4 w-4 text-pink-600">
                        <span class="text-sm">${o.subject}: ${o.topic}</span>
                      </div>
                    `).join('') || '<span class="text-gray-400 text-sm">No tasks scheduled</span>'}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        document.getElementById('daily-schedule-section').innerHTML = `
          <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-calendar-alt text-indigo-500 mr-2"></i>Daily Routine Scheduler</h2>
          <div id="dailyRoutineCalendar" class="w-full space-y-3"></div>
        `;
        showDailyRoutine(false);
      }
      
      this.innerHTML = focusMode ? '<i class="fas fa-eye"></i> Exit Focus' : '<i class="fas fa-bullseye"></i> Focus Mode';
    };

    // --- MOTIVATIONAL QUOTES ---
    const quotes = [
      "The North Remembers! Stay Strong.",
      "One topic at a time builds champions.",
      "Tiny progress is still progress â€” keep going.",
      "Every expert was once a beginner.",
      "Your efforts today, your success tomorrow!",
      "Difficult roads lead to beautiful destinations."
    ];
    function showRandomQuote() {
      document.getElementById('motivationQuote').textContent = quotes[Math.floor(Math.random()*quotes.length)];
    }
    showRandomQuote();

    // --- MANUAL SUBJECT/TOPIC ENTRY SECTION ---
    let subjectCounter = 1;
    let manualSubjects = [
      { name: 'Mathematics', topics: ['Algebra', 'Calculus', 'Geometry'], weight: 5 },
      { name: 'Physics', topics: ['Mechanics', 'Optics', 'Electromagnetism'], weight: 3 }
    ];
    function renderManualSubjects() {
      const wrap = document.getElementById('manualSubjects');
      wrap.innerHTML = '';
      manualSubjects.forEach((subj, idx) => {
        const box = document.createElement('div');
        box.className = "bg-gray-100 darkmode:bg-gray-700 rounded p-3";
        box.innerHTML = `
          <input type="text" class="font-semibold px-2 py-1 rounded border w-48 bg-white darkmode:bg-gray-800 mb-1 text-gray-900 darkmode:text-gray-100" 
                 value="${subj.name}" data-subjidx="${idx}" placeholder="Subject Name"/>
          <input type="number" min="1" value="${subj.weight}" class="w-16 px-2 py-1 border rounded bg-white darkmode:bg-gray-800 ml-2" data-weightidx="${idx}" placeholder="Weight" />
          <button class="text-red-800 hover:bg-red-200 rounded px-2 py-1 ml-2 remSubj"><i class="fas fa-times"></i></button>
          <div class="flex flex-wrap items-center mt-2 gap-1">
            ${subj.topics.map((t, tidx) => `
              <span class="bg-indigo-200 darkmode:bg-indigo-800 rounded px-2 py-1 mr-1 text-xs flex items-center">
                ${t} <button data-subj="${idx}" data-top="${tidx}" class="remTopic ml-1 text-xs text-red-700"><i class="fas fa-times"></i></button>
              </span>
            `).join('')}
            <input type="text" class="topicInput px-1 py-1 w-32 border rounded bg-white darkmode:bg-gray-800" placeholder="Add topic..."/>
          </div>
        `;
        wrap.appendChild(box);
      });
      Array.from(document.querySelectorAll('.topicInput')).forEach((inp, idx) => {
        inp.onkeypress = (e) => {
          if (e.key === 'Enter' && inp.value.trim()) {
            manualSubjects[idx].topics.push(inp.value.trim());
            renderManualSubjects();
          }
        };
      });
      Array.from(document.querySelectorAll('.remSubj')).forEach((btn, idx) => {
        btn.onclick = () => {
          manualSubjects.splice(idx,1);
          renderManualSubjects();
        };
      });
      Array.from(document.querySelectorAll('.remTopic')).forEach(btn => {
        btn.onclick = () => {
          const sidx = Number(btn.dataset.subj), tidx = Number(btn.dataset.top);
          manualSubjects[sidx].topics.splice(tidx,1);
          renderManualSubjects();
        }
      });
      Array.from(wrap.querySelectorAll('[data-subjidx]')).forEach(inp => {
        inp.onchange = () => {
          manualSubjects[inp.dataset.subjidx].name = inp.value;
        }
      });
      Array.from(wrap.querySelectorAll('[data-weightidx]')).forEach(inp => {
        inp.onchange = () => {
          manualSubjects[inp.dataset.weightidx].weight = Math.max(1,parseInt(inp.value)||1);
        }
      });
    }
    document.getElementById('toggleManualAdd').onclick = function() {
      const el = document.getElementById('manualAddSection');
      el.classList.toggle('hidden');
      if (!el.classList.contains('hidden')) renderManualSubjects();
    };
    document.getElementById('addSubjectBtn').onclick = function() {
      manualSubjects.push({name: `Subject ${subjectCounter++}`, topics: [], weight: 2});
      renderManualSubjects();
    };

    // --- GROK API KEY HANDLING & PDF PROCESS ---
    let grokApiKey = '';
    let grokApiAuthenticated = false;
    
    document.getElementById('grokSaveBtn').onclick = async function() {
      grokApiKey = document.getElementById('grokApiKey').value.trim();
      const status = document.getElementById('grokApiStatus');
      
      if(!grokApiKey) {
        status.innerHTML = '<span class="text-yellow-700"><i class="fas fa-exclamation-triangle"></i> API Key Required for PDF Processing</span>';
        grokApiAuthenticated = false;
        updateApiAuthUI(false);
        return;
      }
      
      // Validate API key with Grok
      status.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Verifying API key...</span>';
      
      try {
        // Use a simple request to validate the API key
        const response = await fetch('https://api.groq.com/openai/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${grokApiKey}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          status.innerHTML = '<span class="text-green-600"><i class="fas fa-check"></i> API Key Verified</span>';
          grokApiAuthenticated = true;
          updateApiAuthUI(true);
      } else {
          status.innerHTML = '<span class="text-red-600"><i class="fas fa-times"></i> Invalid API Key</span>';
          grokApiAuthenticated = false;
          updateApiAuthUI(false);
        }
      } catch (error) {
        status.innerHTML = '<span class="text-red-600"><i class="fas fa-times"></i> API Connection Error</span>';
        console.error('Grok API validation error:', error);
        grokApiAuthenticated = false;
        updateApiAuthUI(false);
      }
    };

    // --- PDF UPLOAD & PROCESSING ---
    let extractedSubjects = [];
    document.getElementById('pdfInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!grokApiAuthenticated) {
        document.getElementById('apiErrorMsg').classList.remove('hidden');
        document.getElementById('apiErrorMsg').textContent = 'Please enter and verify your Grok API key before uploading a PDF.';
        this.value = null; // Clear the file input
        return;
      }
      
      // Show processing UI
      showPdfProcessing(true);
      document.getElementById('pdfProcessMsg').classList.remove('hidden');
      document.getElementById('pdfProcessMsg').textContent = 'Processing PDF: extracting topics with Grok AI...';
      document.getElementById('apiErrorMsg').classList.add('hidden');

      try {
        // Convert PDF to text using pdf.js before sending to Grok API
      const arrayBuffer = await file.arrayBuffer();
        
        // Dynamically load PDF.js if not already loaded
        if (typeof pdfjsLib === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
          document.head.appendChild(script);
          
          // Wait for script to load
          await new Promise(resolve => {
            script.onload = resolve;
          });
          
          // Set worker source
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
        }
        
        // Load and parse PDF document
        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;
        let pdfText = '';
        
        // Extract text from all pages
        for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) { // Limit to 10 pages to avoid token limits
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          pdfText += strings.join(' ') + '\n';
        }
        
        // Prepare prompt for Grok API to analyze the PDF content
        const prompt = `
You are an expert study planner helping a student prepare for exams. 
Analyze this content from their PDF syllabus or study material:

${pdfText.slice(0, 4000)}

Extract:
1. The main subjects covered in this material
2. Important topics under each subject that need to be studied
3. Assign a priority weight (1-5) to each subject based on difficulty and importance

Format your response as a valid JSON array with this structure:
[
  {
    "name": "Subject Name",
    "topics": ["Topic 1", "Topic 2", "Topic 3", ...],
    "weight": priority_number
  },
  ...
]

ONLY respond with the JSON array, no other text.
`;

        // Call Grok API with the extracted text
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${grokApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama3-70b-8192',
            messages: [
              {
                role: 'system',
                content: 'You are an expert study planner assistant that helps analyze academic content and create structured study plans.'
              },
              {
                role: 'user',
                content: prompt
              }
            ],
            temperature: 0.1,
            max_tokens: 2000
          })
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const result = await response.json();
        const content = result.choices[0].message.content;
        
        try {
          // Try to parse the JSON response
          const jsonMatch = content.match(/\[\s*\{.*\}\s*\]/s);
          let jsonContent = jsonMatch ? jsonMatch[0] : content;
          
          // Some cleanup in case the model didn't return pure JSON
          jsonContent = jsonContent.replace(/```json|```/g, '').trim();
          
          extractedSubjects = JSON.parse(jsonContent);
          document.getElementById('pdfProcessMsg').textContent = 'PDF processed via Grok AI. Subjects and topics extracted!';
          document.getElementById('pdfProcessMsg').classList.add('text-green-600');
          
          // Show analysis details
          document.getElementById('pdfAnalysisDetails').classList.remove('hidden');
          
          // Update subject/weight inputs after extraction
          renderSubjectWeights();
        } catch (jsonError) {
          console.error('JSON parsing error:', jsonError, content);
          document.getElementById('apiErrorMsg').classList.remove('hidden');
          document.getElementById('apiErrorMsg').textContent = 'Could not parse the API response. Falling back to basic extraction...';
          // Try to extract json from the response text in case it's malformed
          try {
            const fixedJson = content.match(/\[\s*\{[\s\S]*\}\s*\]/);
            if (fixedJson) {
              extractedSubjects = JSON.parse(fixedJson[0]);
              document.getElementById('pdfProcessMsg').textContent = 'PDF processed with partial success!';
              renderSubjectWeights();
            } else {
              fallbackExtraction();
            }
          } catch (e) {
            fallbackExtraction();
          }
        }
        } catch (err) {
        console.error('PDF processing error:', err);
          document.getElementById('apiErrorMsg').classList.remove('hidden');
        document.getElementById('apiErrorMsg').textContent = `Error processing PDF: ${err.message}. Falling back to basic extraction.`;
        fallbackExtraction();
      } finally {
        // Hide processing UI when done
        showPdfProcessing(false);
      }
    });
    
    function fallbackExtraction() {
      // Simple fallback when API fails - provide more useful fallback data
      document.getElementById('pdfProcessMsg').textContent = 'Using basic PDF topic extraction...';
      // Attempt to extract common academic subjects from filename if possible
      const filename = document.getElementById('pdfInput').files[0]?.name || '';
      let detectedSubject = '';
      
      // Try to detect subject from filename
      if (filename.toLowerCase().includes('math')) detectedSubject = 'Mathematics';
      else if (filename.toLowerCase().includes('physics')) detectedSubject = 'Physics';
      else if (filename.toLowerCase().includes('chem')) detectedSubject = 'Chemistry';
      else if (filename.toLowerCase().includes('bio')) detectedSubject = 'Biology';
      else if (filename.toLowerCase().includes('eng') || filename.toLowerCase().includes('lit')) detectedSubject = 'English';
      else if (filename.toLowerCase().includes('hist')) detectedSubject = 'History';
      else if (filename.toLowerCase().includes('geo')) detectedSubject = 'Geography';
      else if (filename.toLowerCase().includes('comp') || filename.toLowerCase().includes('cs')) detectedSubject = 'Computer Science';
      
        extractedSubjects = [
        { 
          name: detectedSubject || "Subject from PDF", 
          topics: ["Topic 1 (extracted)", "Topic 2 (extracted)", "Topic 3 (extracted)"], 
          weight: 3 
        },
        { 
          name: "Additional Subject", 
          topics: ["Chapter 1", "Chapter 2", "Important Concept"], 
          weight: 2 
        }
      ];
      renderSubjectWeights();
    }

    // --- SUBJECT & WEIGHT INPUTS DYNAMIC RENDER ---
    function renderSubjectWeights() {
      let subjectInputs = '';
      const subs = extractedSubjects.length ? extractedSubjects : manualSubjects;
      subs.forEach((subj, i) => {
        subjectInputs += `<div class="flex flex-col sm:flex-row sm:items-center gap-1">
          <input type="text" class="w-40 px-2 py-1 rounded border border-gray-300 bg-white darkmode:bg-gray-800 font-semibold" value="${subj.name}" data-sindex="${i}" placeholder="Subject"/>
          <input type="number" min="1" max="10" value="${subj.weight||2}" class="w-16 px-2 py-1 rounded border border-gray-300 bg-white darkmode:bg-gray-800" data-windex="${i}" placeholder="Weight"/>
          <span class="text-xs text-gray-500 ml-2">${(subj.topics||[]).length} topics</span>
        </div>`;
      });
      document.getElementById('subjectWeightInputs').innerHTML = subjectInputs;
    }
    renderSubjectWeights();

    // --- PLAN GENERATOR (SMART ALLOCATION) ---
    let studyPlan = {};
    let progress = {};
    document.getElementById('planGenForm').onsubmit = function(e) {
      e.preventDefault();
      // 1. Subjects and weights
      const useSubs = extractedSubjects.length ? extractedSubjects : manualSubjects;
      // Read edited weights
      Array.from(document.querySelectorAll('#subjectWeightInputs [data-windex]')).forEach(inp => {
        useSubs[inp.dataset.windex].weight = Math.max(1, parseInt(inp.value)||2);
        useSubs[inp.dataset.windex].name = document.querySelector('#subjectWeightInputs [data-sindex="'+inp.dataset.windex+'"]').value;
      });
      // 2. Dates & Settings
      const sDate = new Date(document.getElementById('examStart').value);
      const eDate = new Date(document.getElementById('examEnd').value);
      if (isNaN(sDate.getTime()) || isNaN(eDate.getTime()) || eDate <= sDate) {
        alert("Please set valid exam dates.");
        return;
      }
      const nDays = Math.ceil((eDate - sDate) / (1000*60*60*24)) + 1;
      // 3. Build study slots
      let plan = {}; // { "date key": { am:[topic, ...], pm:[], eve:[] } }
      let totalTopics = 0, topicAlloc = [];
      useSubs.forEach((sub) => totalTopics += (sub.topics||[]).length);
      // Slot allocation weights
      const totalWeight = useSubs.reduce((acc, s) => acc + (+s.weight || 1), 0);
      // Flatten topic list by subject & priority-weight
      useSubs.forEach((sub, sidx) => {
        (sub.topics||[]).forEach(topic => {
          // Duplicate heavy subject topics to give them higher slot occurrence
          for (let w = 0; w < Math.max(1, parseInt(sub.weight)); ++w) {
            topicAlloc.push({subject: sub.name, sidx, topic});
          }
        });
      });
      // Shuffle and allocate topics across dates
      let shuffled = topicAlloc.sort(() => Math.random() - 0.5);
      // Assign to days and slots
      let slotsPerDay = 3, pointer = 0;
      for (let d = 0; d < nDays; ++d) {
        let curr = new Date(sDate.getTime()+d*24*60*60*1000), ymd = curr.toISOString().slice(0,10);
        plan[ymd]={ am:[], pm:[], eve:[] };
        for (let s=0; s<slotsPerDay; ++s) {
          if (pointer < shuffled.length)
            plan[ymd][['am','pm','eve'][s]].push(shuffled[pointer++]);
        }
      }
      studyPlan = {
        start: sDate,
        end: eDate,
        subjects: JSON.parse(JSON.stringify(useSubs)),
        plan: plan
      };
      // Progress mapping
      progress = {};
      useSubs.forEach(sub=>{
        progress[sub.name]={ total: (sub.topics||[]).length, done: 0, completion: 0, checked: Array((sub.topics||[]).length).fill(false)};
      });
      showDashboard();
      showDailyRoutine();
      
      // Show workflow section after plan is generated
      document.getElementById('workflow-section').classList.remove('hidden');
      document.getElementById('topic-explanation-section').classList.remove('hidden');
      
      // Populate workflow subject dropdown
      populateWorkflowSubjects();
    };
    
    // --- WORKFLOW VISUALIZATION ---
    function populateWorkflowSubjects() {
      const select = document.getElementById('workflowSubject');
      select.innerHTML = '<option value="">Select a subject</option>';
      if (studyPlan.subjects) {
        studyPlan.subjects.forEach((subject, index) => {
          select.innerHTML += `<option value="${index}">${subject.name}</option>`;
        });
      }
    }
    
    document.getElementById('generateWorkflowBtn').addEventListener('click', async function() {
      const subjectIndex = document.getElementById('workflowSubject').value;
      if (!subjectIndex) {
        alert('Please select a subject first');
        return;
      }
      
      const subject = studyPlan.subjects[subjectIndex];
      if (!subject) return;
      
      // Show loading
      document.getElementById('workflowLoading').classList.remove('hidden');
      document.getElementById('workflowContent').innerHTML = '';
      
      try {
        // Generate a basic but guaranteed-to-work diagram for the selected subject
        const diagram = generateReliableDiagram(subject);
        
        // Create HTML structure for the workflow diagram
        const workflowHTML = `
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">${subject.name} Study Path</h3>
            <div class="p-4 rounded overflow-auto bg-gray-50 dark:bg-gray-800">
              <div class="mermaid">${diagram}</div>
            </div>
          </div>
        `;
        
        document.getElementById('workflowContent').innerHTML = workflowHTML;
        
        // Load Mermaid library dynamically and render the diagram
        if (typeof mermaid === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js';
          script.onload = function() {
            configureMermaid();
            try {
              mermaid.run();
            } catch (error) {
              console.error('Mermaid rendering error:', error);
              showDiagramError();
            }
          };
          document.head.appendChild(script);
        } else {
          configureMermaid();
          try {
            mermaid.run();
          } catch (error) {
            console.error('Mermaid rendering error:', error);
            showDiagramError();
          }
        }
      } catch (error) {
        console.error('Workflow generation error:', error);
        showDiagramError();
      } finally {
        document.getElementById('workflowLoading').classList.add('hidden');
      }
    });
    
    function showDiagramError() {
      document.getElementById('workflowContent').innerHTML = `
        <div class="text-red-600 p-4 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded">
          <p><i class="fas fa-exclamation-triangle mr-2"></i> Could not render the study path diagram.</p>
          <p class="mt-2 text-sm">Please try again or select a different subject.</p>
        </div>
      `;
    }
    
    // Generate a reliable diagram that is guaranteed to work with mermaid
    function generateReliableDiagram(subject) {
      const topics = subject.topics || [];
      
      // Start with flowchart definition
      let diagram = 'flowchart LR\n';
      
      // Add a start node
      diagram += '    start[Start]\n';
      
      // Create node definitions with safe IDs and labels
      topics.forEach((topic, index) => {
        // Create a safe node ID (alphanumeric only)
        const nodeId = `topic${index + 1}`;
        
        // Create a safe label (escape quotes)
        const safeLabel = topic.replace(/"/g, "'");
        
        // Add the node definition
        diagram += `    ${nodeId}["${safeLabel}"]\n`;
      });
      
      // If no topics, add a placeholder
      if (topics.length === 0) {
        diagram += '    noTopics["No topics available"]\n';
        diagram += '    start --> noTopics\n';
        return diagram;
      }
      
      // Connect the nodes sequentially
      diagram += '    start --> topic1\n';
      
      for (let i = 1; i < topics.length; i++) {
        diagram += `    topic${i} --> topic${i+1}\n`;
      }
      
      // Create groupings for related topics if there are enough topics
      if (topics.length >= 6) {
        // Create a subgraph for the first half
        diagram += '    subgraph "Foundation Concepts"\n';
        for (let i = 1; i <= Math.floor(topics.length / 2); i++) {
          diagram += `        topic${i}\n`;
        }
        diagram += '    end\n';
        
        // Create a subgraph for the second half
        diagram += '    subgraph "Advanced Topics"\n';
        for (let i = Math.floor(topics.length / 2) + 1; i <= topics.length; i++) {
          diagram += `        topic${i}\n`;
        }
        diagram += '    end\n';
      }
      
      return diagram;
    }
    
    function configureMermaid() {
      const config = {
        startOnLoad: true,
        theme: darkMode ? 'dark' : 'default',
        darkMode: darkMode,
        flowchart: {
          htmlLabels: true,
          curve: 'basis',
          diagramPadding: 8
        },
        securityLevel: 'loose',
        themeVariables: {
          darkMode: darkMode,
          primaryColor: '#60a5fa',
          primaryTextColor: darkMode ? '#e5e7eb' : '#333333',
          primaryBorderColor: '#4b4c57',
          lineColor: darkMode ? '#8b8b9e' : '#666666',
          secondaryColor: '#5EEAD4',
          tertiaryColor: darkMode ? '#3a3b46' : '#f9fafb',
          // Specific flowchart colors
          nodeBorder: darkMode ? '#8b8b9e' : '#333333',
          nodeTextColor: darkMode ? '#e5e7eb' : '#333333'
        }
      };
      mermaid.initialize(config);
    }

    // --- TOPIC EXPLANATION ---
    document.getElementById('explainTopicBtn').addEventListener('click', async function() {
      const topic = document.getElementById('topicQuery').value.trim();
      if (!topic) {
        alert('Please enter a topic to explain');
        return;
      }
      
      // Show loading
      document.getElementById('topicLoading').classList.remove('hidden');
      document.getElementById('topicContent').innerHTML = '';
      
      try {
        // Call Grok API to get topic explanation
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${grokApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama3-70b-8192',
            messages: [
              {
                role: 'system',
                content: 'You are an expert tutor that explains academic concepts clearly and concisely with examples.'
              },
              {
                role: 'user',
                content: `Explain the topic "${topic}" in a comprehensive way. Include:
                1. A clear definition
                2. Key principles or formulas
                3. A simple example
                4. Common misconceptions
                5. How it connects to other related topics
                
                Format your response with markdown for readability. Use bold headings (##) for each section.
                For formulas, use proper markdown code blocks with appropriate formatting.
                Keep your explanations clear, accurate, and educational.`
              }
            ],
            temperature: 0.3,
            max_tokens: 1000
          })
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const result = await response.json();
        const content = result.choices[0].message.content;
        
        // Load markdown library and render content with proper styling
        if (typeof marked === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
          script.onload = function() {
            // Configure marked options for better rendering
            marked.setOptions({
              gfm: true,
              breaks: true,
              headerIds: true,
              highlight: function(code, lang) {
                return code;
              }
            });
            
            const markedContent = marked.parse(content);
            
            // Add additional styling classes for dark mode compatibility
            const styledContent = `
              <div class="markdown-content">
                ${markedContent}
              </div>
            `;
            
            document.getElementById('topicContent').innerHTML = styledContent;
            
            // Add styles for code blocks
            applyExplanationStyles();
          };
          document.head.appendChild(script);
        } else {
          // Configure marked options for better rendering
          marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: true,
            highlight: function(code, lang) {
              return code;
            }
          });
          
          const markedContent = marked.parse(content);
          
          // Add additional styling classes for dark mode compatibility
          const styledContent = `
            <div class="markdown-content">
              ${markedContent}
            </div>
          `;
          
          document.getElementById('topicContent').innerHTML = styledContent;
          
          // Add styles for code blocks
          applyExplanationStyles();
        }
      } catch (error) {
        console.error('Topic explanation error:', error);
        document.getElementById('topicContent').innerHTML = `
          <div class="text-red-600 p-4 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded">
            <p><i class="fas fa-exclamation-triangle mr-2"></i> Error generating explanation: ${error.message}</p>
            <p class="mt-2 text-sm">Please try again or modify your query.</p>
          </div>
        `;
      } finally {
        document.getElementById('topicLoading').classList.add('hidden');
      }
    });
    
    // Apply additional styles to the explanation content for better readability
    function applyExplanationStyles() {
      const content = document.querySelector('.markdown-content');
      if (!content) return;
      
      // Let CSS handle all the styling for consistent appearance
      // Just add some utility classes
      
      // Make tables look better if present
      content.querySelectorAll('table').forEach(table => {
        table.classList.add('w-full', 'border-collapse', 'my-4');
        table.style.borderSpacing = '0';
      });
      
      content.querySelectorAll('th, td').forEach(cell => {
        cell.classList.add('border', 'p-2');
        cell.style.borderColor = darkMode ? '#4b4c57' : '#e5e7eb';
      });
      
      // Make blockquotes look nice
      content.querySelectorAll('blockquote').forEach(quote => {
        quote.classList.add('border-l-4', 'pl-4', 'italic', 'my-4');
        quote.style.borderColor = darkMode ? '#4b4c57' : '#e5e7eb';
        quote.style.color = darkMode ? '#d1d5db' : '#4b5563';
      });
      
      // Make strong text stand out
      content.querySelectorAll('strong').forEach(strong => {
        strong.style.color = darkMode ? '#f9fafb' : '#111827';
      });
    }

    // --- SHOW KANBAN DASHBOARD ---
    function showDashboard() {
      // Cards per subject w. checklist
      const subjectCards = document.getElementById('subjectCards');
      subjectCards.innerHTML = '';
      (studyPlan.subjects||[]).forEach((sub, sIdx) => {
        const card = document.createElement('div');
        card.className = "card kanban-shadow w-full sm:w-64 bg-white dark-card rounded-lg p-4 animate-fade";
        
        // Get a unique color for each subject
        const colors = ['indigo', 'teal', 'pink', 'amber', 'emerald', 'blue', 'purple', 'red'];
        const colorIndex = sIdx % colors.length;
        const color = colors[colorIndex];
        
        // Calculate completion
        const completionPercentage = (progress[sub.name].completion*100).toFixed(0);
        
        card.innerHTML = `
          <div class="flex flex-row items-center mb-3">
            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-${color}-100 text-${color}-600 mr-3">
              <i class="fas ${getSubjectIcon(sub.name)} text-lg"></i>
          </div>
            <div>
              <h3 class="font-bold text-lg truncate">${sub.name}</h3>
              <div class="flex items-center text-xs text-gray-500 darkmode:text-gray-400">
                <span>Weight: ${sub.weight||1}</span>
                <span class="ml-2 px-2 py-1 rounded ${completionPercentage > 70 ? `bg-${color}-200 text-${color}-800` : 'bg-gray-200 text-gray-700'}">${completionPercentage}%</span>
              </div>
            </div>
          </div>
          
          <div class="mb-3 w-full">
            <div class="bg-gray-200 darkmode:bg-gray-700 rounded-full h-2 overflow-hidden">
              <div style="width:${progress[sub.name].completion*100}%" class="bg-${color}-500 h-2 rounded-full"></div>
            </div>
          </div>
          
          <div class="h-40 no-scrollbar overflow-auto space-y-1.5 mb-2">
          ${(sub.topics||[]).length > 0
            ? sub.topics.map((t, idx) => `
              <div class="flex items-center p-1.5 rounded hover:bg-gray-100 darkmode:hover:bg-gray-700 transition-colors">
                <label class="flex items-center space-x-2 text-sm w-full cursor-pointer">
                  <input type="checkbox" class="cb-topic h-4 w-4 rounded border-gray-300 text-${color}-600 focus:ring-${color}-500" 
                    data-sidx="${sIdx}" data-tidx="${idx}" ${progress[sub.name].checked[idx]?'checked':''}>
                  <span${progress[sub.name].checked[idx]?' class="line-through text-gray-400"':''}>${t}</span>
                </label>
              </div>`).join('')
            : '<span class="text-gray-400 text-xs">No topics added</span>'
          }
          </div>
        `;
        subjectCards.appendChild(card);
      });
      // Checkbox logic
      document.querySelectorAll('.cb-topic').forEach(inp=>{
        inp.onchange = function() {
          const si = +inp.dataset.sidx, ti = +inp.dataset.tidx, sub = studyPlan.subjects[si];
          
          if (!sub || !progress[sub.name]) {
            console.error('Subject or progress data not found');
            return;
          }
          
          // Update checked status
          progress[sub.name].checked[ti] = inp.checked;
          
          // Count completed topics
          progress[sub.name].done = progress[sub.name].checked.filter(Boolean).length;
          
          // Calculate completion percentage (avoid division by zero)
          const topicCount = (sub.topics || []).length || 1;
          progress[sub.name].completion = progress[sub.name].done / topicCount;
          
          // Cap completion at 100%
          if (progress[sub.name].completion > 1) {
            progress[sub.name].completion = 1;
          }
          
          // Update UI without full redraw if possible
          const card = inp.closest('.card');
          if (card) {
            // Update just this card's progress bar
            const progressBar = card.querySelector('[class*="bg-"][class*="-500"]');
            if (progressBar) {
              progressBar.style.width = `${progress[sub.name].completion * 100}%`;
            }
            
            // Update the percentage text
            const percentText = card.querySelector('span[class*="bg-"][class*="-200"]');
            if (percentText) {
              percentText.textContent = `${Math.round(progress[sub.name].completion * 100)}%`;
            }
          } else {
            // Fallback to full redraw
          showDashboard();
          }
          
          // Always update the chart
          showProgressChart();
        };
      });
      showProgressChart();
    }
    
    // Get appropriate icon for subject
    function getSubjectIcon(subjectName) {
      const name = subjectName.toLowerCase();
      if (name.includes('math')) return 'fa-square-root-alt';
      if (name.includes('physics')) return 'fa-atom';
      if (name.includes('chem')) return 'fa-flask';
      if (name.includes('bio')) return 'fa-dna';
      if (name.includes('english') || name.includes('lit')) return 'fa-book';
      if (name.includes('history')) return 'fa-landmark';
      if (name.includes('geo')) return 'fa-globe-americas';
      if (name.includes('comp') || name.includes('cs')) return 'fa-laptop-code';
      // Default icon
      return 'fa-book';
    }

    // --- PROGRESS CHART ---
    let chart;
    function showProgressChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      const subjects = studyPlan.subjects || [];
      const labels = subjects.map(s=>s.name);
      const values = subjects.map(s=>Math.round(progress[s.name]?.completion*100||0));
      
      // Generate colors for each subject
      const colors = subjects.map((s, idx) => {
        const colorOptions = ['#818CF8', '#5EEAD4', '#F472B6', '#FB923C', '#4ADE80', '#38BDF8', '#A78BFA', '#FB7185'];
        return colorOptions[idx % colorOptions.length];
      });
      
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Completion %',
            data: values,
            backgroundColor: colors,
            borderRadius: 6,
            barThickness: 24,
            maxBarThickness: 28
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: { 
            legend: {display: false},
            tooltip: {
              callbacks: {
                label: function(context) {
                  const subject = subjects[context.dataIndex];
                  return `${context.parsed.x}% complete (${progress[subject.name].done}/${subject.topics.length} topics)`;
                }
              }
            }
          },
          scales: { 
            x: {
              min: 0,
              max: 100,
              ticks: {stepSize: 25},
              grid: {
                display: true,
                drawOnChartArea: true,
                drawTicks: true,
                color: darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'
              }
            },
            y: {
              grid: {
                display: false
              }
            }
          },
          responsive: true,
          maintainAspectRatio: true,
          // Ensure the chart stays within container bounds
          layout: {
            padding: {
              top: 10,
              bottom: 10
            }
          }
        }
      });
      
      // Adding a fixed height control based on number of subjects
      const chartContainer = document.querySelector('#progressChart').parentNode;
      // If we have many subjects, we'll manage the container height
      if (subjects.length > 5) {
        chartContainer.style.height = `${Math.min(300, 150 + subjects.length * 30)}px`;
        chartContainer.style.overflowY = 'auto';
      } else {
        chartContainer.style.height = '250px';
        chartContainer.style.overflowY = 'visible';
      }
    }

    // --- DAILY ROUTINE CALENDAR ---
    function showDailyRoutine(justToday=false) {
      const cWrap = document.getElementById('dailyRoutineCalendar');
      if (!studyPlan.plan) {
        cWrap.innerHTML = '<div class="text-gray-500 text-center text-sm p-4">Generate a plan to see your daily schedule.</div>';
        return;
      }
      let html = '';
      // Format for PDF: avoid overflow, so wrap per day
      const plan = studyPlan.plan;
      const keys = Object.keys(plan);
      let showDays = justToday ? [ (new Date()).toISOString().slice(0,10) ] : keys;
      showDays.forEach(ymd=>{
        if(!plan[ymd]) return;
        html += `<div class="bg-white dark-card rounded p-4 shadow-sm mb-3 animate-fade">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center">
                <div class="text-indigo-700 darkmode:text-indigo-300 font-semibold">${formatDate(ymd)}</div>
                <span class="text-xs ml-2 text-gray-400">${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(ymd).getDay()]}</span>
            </div>
              <div class="text-xs text-gray-500">${getDayStatus(ymd)}</div>
              </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="rounded-lg bg-teal-50 dark:bg-teal-900/30 p-3">
                <div class="text-xs text-teal-700 dark:text-teal-300 mb-2 font-medium flex items-center">
                  <i class="fas fa-sun mr-1"></i> Morning
              </div>
                <div class="space-y-2">
                ${plan[ymd].am.map(o=> `
                  <div class="bg-white dark-card p-2 rounded-md text-xs shadow-sm flex items-center">
                    <span class="w-2 h-2 rounded-full bg-teal-500 mr-2 flex-shrink-0"></span>
                    <span class="font-medium mr-1">${o.subject}:</span> ${o.topic}
                  </div>`).join('') || '<div class="text-gray-400 text-xs italic">No tasks planned</div>'}
                </div>
              </div>
              <div class="rounded-lg bg-indigo-50 dark:bg-indigo-900/30 p-3">
                <div class="text-xs text-indigo-700 dark:text-indigo-300 mb-2 font-medium flex items-center">
                  <i class="fas fa-clock mr-1"></i> Afternoon
                </div>
                <div class="space-y-2">
                ${plan[ymd].pm.map(o=> `
                  <div class="bg-white dark-card p-2 rounded-md text-xs shadow-sm flex items-center">
                    <span class="w-2 h-2 rounded-full bg-indigo-500 mr-2 flex-shrink-0"></span>
                    <span class="font-medium mr-1">${o.subject}:</span> ${o.topic}
                  </div>`).join('') || '<div class="text-gray-400 text-xs italic">No tasks planned</div>'}
                </div>
              </div>
              <div class="rounded-lg bg-pink-50 dark:bg-pink-900/30 p-3">
                <div class="text-xs text-pink-700 dark:text-pink-300 mb-2 font-medium flex items-center">
                  <i class="fas fa-moon mr-1"></i> Evening
                </div>
                <div class="space-y-2">
                ${plan[ymd].eve.map(o=> `
                  <div class="bg-white dark-card p-2 rounded-md text-xs shadow-sm flex items-center">
                    <span class="w-2 h-2 rounded-full bg-pink-500 mr-2 flex-shrink-0"></span>
                    <span class="font-medium mr-1">${o.subject}:</span> ${o.topic}
                  </div>`).join('') || '<div class="text-gray-400 text-xs italic">No tasks planned</div>'}
                </div>
              </div>
            </div>
          </div>`;
      });
      cWrap.innerHTML = html;
    }
    
    // Format date to more readable format
    function formatDate(dateString) {
      const date = new Date(dateString);
      const options = { month: 'short', day: 'numeric', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }
    
    // Get day status (today, past, upcoming)
    function getDayStatus(dateString) {
      const today = new Date().toISOString().slice(0,10);
      const date = new Date(dateString);
      const nowDate = new Date(today);
      
      if (dateString === today) {
        return '<span class="px-2 py-0.5 bg-green-200 text-green-800 rounded-full">Today</span>';
      } else if (date < nowDate) {
        return '<span class="px-2 py-0.5 bg-gray-200 text-gray-800 rounded-full">Past</span>';
      } else {
        return '<span class="px-2 py-0.5 bg-blue-200 text-blue-800 rounded-full">Upcoming</span>';
      }
    }
    
    // Update mermaid theme when dark mode changes
    function updateMermaidTheme() {
      if (typeof mermaid !== 'undefined') {
        mermaid.initialize({ 
          startOnLoad: true, 
          theme: darkMode ? 'dark' : 'default',
          darkMode: darkMode
        });
        
        // Re-render any existing diagrams
        try {
          mermaid.run();
        } catch (e) {
          console.log('No mermaid diagrams to update');
        }
      }
    }

    // --- ROUTINE PREFERENCE LOGIC ---
    document.getElementById('routinePref').onchange = function() {
      document.getElementById('customRoutineInputs').classList.toggle('hidden', this.value !== 'custom');
    };

    // --- INITIALIZE ---
    // Show API authentication message
    document.getElementById('grokApiAuthMessage').classList.remove('hidden');
    // Initially disable PDF upload until API is authenticated
    document.getElementById('pdfInput').disabled = true;
    document.getElementById('pdfInput').classList.add('opacity-50', 'cursor-not-allowed');
    document.getElementById('apiErrorMsg').classList.remove('hidden');
    document.getElementById('apiErrorMsg').textContent = 'Please verify your Grok API key to enable AI-powered PDF analysis';
    
    // Update UI when API is authenticated
    function updateApiAuthUI(authenticated) {
      document.getElementById('grokApiAuthMessage').classList.toggle('hidden', authenticated);
      document.getElementById('pdfInput').disabled = !authenticated;
      document.getElementById('pdfInput').classList.toggle('opacity-50', !authenticated);
      document.getElementById('pdfInput').classList.toggle('cursor-not-allowed', !authenticated);
      
      if (authenticated) {
        document.getElementById('apiErrorMsg').classList.add('hidden');
      } else {
        document.getElementById('apiErrorMsg').classList.remove('hidden');
        document.getElementById('apiErrorMsg').textContent = 'Please verify your Grok API key to enable AI-powered PDF analysis';
      }
    }
    
    // Add loading indicator during PDF processing
    function showPdfProcessing(show) {
      document.getElementById('pdfProcessingOverlay').classList.toggle('hidden', !show);
    }
    
    // Render initial state for subject weights, manual
    renderSubjectWeights();

    // --- PDF EXPORT FUNCTIONALITY ---
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
      if (!studyPlan.plan) {
        alert('Please generate a study plan first before exporting to PDF.');
        return;
      }

      // Let user know PDF is generating
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
      const btn = this;
      
      // Add html2pdf library dynamically
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      script.onload = function() {
        // Prepare export content
        const appContent = document.getElementById('app').cloneNode(true);
        
        // Remove buttons and inputs that aren't needed in PDF
        appContent.querySelectorAll('button, input[type="file"], input[type="text"]').forEach(el => {
          if (!el.closest('.daily-tasks-list')) { // Preserve checkboxes in daily tasks
            el.remove();
          }
        });
        
        // Remove API section
        const apiSection = appContent.querySelector('#grok-api-section');
        if (apiSection) apiSection.remove();
        
        // PDF options
        const opt = {
          margin: [0.5, 0.5, 0.5, 0.5],
          filename: 'StudyMate_Plan.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        // Generate PDF
        html2pdf().set(opt).from(appContent).save().then(() => {
          btn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
        });
      };
      document.head.appendChild(script);
    });
  </script>
</body>
</html>